import{_ as s,c as i,G as a,b as n}from"./chunks/framework.D5KJDRhN.js";const p=JSON.parse('{"title":"31FFIï¼šRustå¦‚ä½•å’Œä½ çš„è¯­è¨€æ¶èµ·æ²Ÿé€šæ¡¥æ¢ï¼Ÿ","description":"","frontmatter":{"title":"31FFIï¼šRustå¦‚ä½•å’Œä½ çš„è¯­è¨€æ¶èµ·æ²Ÿé€šæ¡¥æ¢ï¼Ÿ","date":"2025-02-22T00:00:00.000Z","categories":["é™ˆå¤©Â·Rustç¼–ç¨‹ç¬¬ä¸€è¯¾"],"head":[["link",{"rel":"canonical","href":"https://www.doit.ip-ddns.com/pages/repository/ç¼–ç¨‹/é™ˆå¤©Â·Rustç¼–ç¨‹ç¬¬ä¸€è¯¾/31FFIï¼šRustå¦‚ä½•å’Œä½ çš„è¯­è¨€æ¶èµ·æ²Ÿé€šæ¡¥æ¢ï¼Ÿ"}]]},"headers":[],"relativePath":"pages/repository/ç¼–ç¨‹/é™ˆå¤©Â·Rustç¼–ç¨‹ç¬¬ä¸€è¯¾/31FFIï¼šRustå¦‚ä½•å’Œä½ çš„è¯­è¨€æ¶èµ·æ²Ÿé€šæ¡¥æ¢ï¼Ÿ.md","filePath":"pages/repository/ç¼–ç¨‹/é™ˆå¤©Â·Rustç¼–ç¨‹ç¬¬ä¸€è¯¾/31FFIï¼šRustå¦‚ä½•å’Œä½ çš„è¯­è¨€æ¶èµ·æ²Ÿé€šæ¡¥æ¢ï¼Ÿ.md","lastUpdated":1740213738000}');const l=s({name:"pages/repository/ç¼–ç¨‹/é™ˆå¤©Â·Rustç¼–ç¨‹ç¬¬ä¸€è¯¾/31FFIï¼šRustå¦‚ä½•å’Œä½ çš„è¯­è¨€æ¶èµ·æ²Ÿé€šæ¡¥æ¢ï¼Ÿ.md"},[["render",function(s,p,l,e,t,h){return n(),i("div",null,p[0]||(p[0]=[a('<div class="language-text vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>                            31 FFIï¼šRustå¦‚ä½•å’Œä½ çš„è¯­è¨€æ¶èµ·æ²Ÿé€šæ¡¥æ¢ï¼Ÿ</span></span>\n<span class="line"><span>                            ä½ å¥½ï¼Œæˆ‘æ˜¯é™ˆå¤©ã€‚</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>FFIï¼ˆForeign Function Interfaceï¼‰ï¼Œä¹Ÿå°±æ˜¯å¤–éƒ¨å‡½æ•°æ¥å£ï¼Œæˆ–è€…è¯´è¯­è¨€äº¤äº’æ¥å£ï¼Œå¯¹äºå¤§éƒ¨åˆ†å¼€å‘è€…æ¥è¯´ï¼Œæ˜¯ä¸€ä¸ªç¥ç§˜çš„å­˜åœ¨ï¼Œå¹³æ—¶å¯èƒ½å‡ ä¹ä¸ä¼šæ¥è§¦åˆ°å®ƒï¼Œæ›´åˆ«è¯´æ’°å†™ FFI ä»£ç äº†ã€‚</p><p>å…¶å®ä½ ç”¨çš„è¯­è¨€ç”Ÿæ€æœ‰å¾ˆå¤§ä¸€éƒ¨åˆ†æ˜¯ç”± FFI æ„å»ºçš„ã€‚æ¯”å¦‚ä½ åœ¨ Python ä¸‹ä½¿ç”¨ç€ NumPy æ„‰å¿«åœ°åšç€æ•°å€¼è®¡ç®—ï¼Œæ®Šä¸çŸ¥ NumPy çš„åº•å±‚ç»†èŠ‚éƒ½æ˜¯ç”± C æ„å»ºçš„ï¼›å½“ä½ ç”¨ Rust æ—¶ï¼Œèƒ½å¼€å¿ƒåœ°ä½¿ç”¨ç€ OpenSSL ä¸ºä½ çš„ HTTP æœåŠ¡ä¿é©¾æŠ¤èˆªï¼Œå…¶å®åº•ä¸‹ä¹Ÿæ˜¯ C åœ¨å¤„ç†ç€ä¸€åˆ‡åè®®ç®—æ³•ã€‚</p><p>æˆ‘ä»¬ç°åœ¨æ‰€å¤„çš„è½¯ä»¶ä¸–ç•Œï¼Œå‡ ä¹æ‰€æœ‰çš„ç¼–ç¨‹è¯­è¨€éƒ½åœ¨å’Œ C æ‰“é€ å‡ºæ¥çš„ç”Ÿæ€ç³»ç»Ÿæ‰“äº¤é“ï¼Œæ‰€ä»¥ï¼Œä¸€é—¨è¯­è¨€ï¼Œå¦‚æœèƒ½è·Ÿ C ABIï¼ˆApplication Binary Interfaceï¼‰å¤„ç†å¥½å…³ç³»ï¼Œé‚£ä¹ˆå°±å‡ ä¹å¯ä»¥å’Œä»»ä½•è¯­è¨€äº’é€šã€‚</p><p>å½“ç„¶ï¼Œå¯¹äºå¤§éƒ¨åˆ†å…¶ä»–è¯­è¨€çš„ä½¿ç”¨è€…æ¥è¯´ï¼Œä¸çŸ¥é“å¦‚ä½•å’Œ C äº’é€šä¹Ÿæ— æ‰€è°“ï¼Œå› ä¸ºå¼€æºä¸–ç•Œé‡Œæ€»æœ‰â€œå‰è¾ˆâ€ä»¬æ›¿æˆ‘ä»¬é“ºå¥½è·¯è®©æˆ‘ä»¬å‰è¿›ï¼›ä½†å¯¹äº Rust è¯­è¨€çš„ä½¿ç”¨è€…æ¥è¯´ï¼Œåœ¨åˆ«äººé“ºå¥½çš„è·¯ä¸Šå‰è¿›ä¹‹ä½™ï¼Œå¶å°”ï¼Œæˆ‘ä»¬è‡ªå·±ä¹Ÿéœ€è¦ä¸ºè‡ªå·±ã€ä¸ºåˆ«äººé“ºä¸€é“ºè·¯ã€‚è°è®© Rust æ˜¯ä¸€é—¨ç³»ç»Ÿçº§åˆ«çš„è¯­è¨€å‘¢ã€‚æ‰€è°“ï¼Œèƒ½åŠ›è¶Šå¤§ï¼Œè´£ä»»è¶Šå¤§å˜›ã€‚</p><p>ä¹Ÿæ­£å› ä¸ºæ­¤ï¼Œå½“å¤§éƒ¨åˆ†è¯­è¨€éƒ½è¿˜åœ¨å¸è¡€ C çš„ç”Ÿæ€æ—¶ï¼ŒRust åœ¨å¤§å¤§æ–¹æ–¹åœ°æå°½æ‰€èƒ½åå“ºç”Ÿæ€ã€‚æ¯”å¦‚ cloudflare å’Œç™¾åº¦çš„ mesalink å°±åˆ†åˆ«æŠŠçº¯ Rust çš„ HTTP/3 å®ç° quiche å’Œ TLS å®ç° Rustlsï¼Œå¼•å…¥åˆ° C/C++ çš„ç”Ÿæ€é‡Œï¼Œè®© C/C++ çš„ç”Ÿæ€æ›´ç¾å¥½ã€æ›´å®‰å…¨ã€‚</p><p>æ‰€ä»¥ç°åœ¨ï¼Œé™¤äº†ç”¨ C/C++ åšåº•å±‚å¤–ï¼Œè¶Šæ¥è¶Šå¤šçš„åº“ä¼šå…ˆç”¨ Rust å®ç°ï¼Œå†æ„å»ºå‡ºå¯¹åº” Pythonï¼ˆpyo3ï¼‰ã€JavaScriptï¼ˆwasmï¼‰ã€Node.jsï¼ˆneonï¼‰ã€Swiftï¼ˆuniffiï¼‰ã€Kotlinï¼ˆuniffiï¼‰ç­‰å®ç°ã€‚</p><p>æ‰€ä»¥å­¦ä¹  Rust æœ‰ä¸€ä¸ªå¥½å¤„å°±æ˜¯ï¼Œå­¦ç€å­¦ç€ï¼Œä½ ä¼šå‘ç°ï¼Œä¸ä½†èƒ½é€ ä¸€å¤§å †è½®å­ç»™è‡ªå·±ç”¨ï¼Œè¿˜èƒ½é€ ä¸€å¤§å †è½®å­ç»™å…¶å®ƒè¯­è¨€ç”¨ï¼Œå¹¶ä¸” Rust çš„ç”Ÿæ€è¿˜å¾ˆæ”¯æŒå’Œé¼“åŠ±ä½ é€ è½®å­ç»™å…¶å®ƒè¯­è¨€ç”¨ã€‚äºæ˜¯ä¹ï¼ŒJava çš„ç†æƒ³â€œä¸€æ¬¡æ’°å†™ï¼Œåˆ°å¤„ä½¿ç”¨â€ï¼Œåœ¨ Rust è¿™é‡Œæˆäº†â€œä¸€æ¬¡æ’°å†™ï¼Œåˆ°å¤„è°ƒç”¨â€ã€‚</p><p>å¥½ï¼ŒèŠäº†è¿™ä¹ˆå¤šï¼Œä½ æ˜¯ä¸æ˜¯å·²ç»éå¸¸å¥½å¥‡ Rust FFI èƒ½åŠ›åˆ°åº•å¦‚ä½•ï¼Ÿå…¶å®ä¹‹å‰æˆ‘ä»¬è§è¯†è¿‡å†°å±±ä¸€è§’ï¼Œåœ¨[ç¬¬ 6 è®²]get hands dirty åšçš„é‚£ä¸ª SQL æŸ¥è¯¢å·¥å…·ï¼Œæˆ‘ä»¬å®ç°äº† Python å’Œ Node.js çš„ç»‘å®šã€‚ä»Šå¤©ï¼Œå°±æ¥æ›´å¹¿æ³›åœ°å­¦ä¹ ä¸€ä¸‹ Rust å¦‚ä½•è·Ÿä½ çš„è¯­è¨€æ¶æ„èµ·æ²Ÿé€šçš„æ¡¥æ¢ã€‚</p><p>Rust è°ƒç”¨Cçš„åº“</p><p>é¦–å…ˆçœ‹ Rust å’Œ C/C++ çš„äº’æ“ä½œã€‚ä¸€èˆ¬è€Œè¨€ï¼Œå½“çœ‹åˆ°ä¸€ä¸ª C/C++ åº“ï¼Œæˆ‘ä»¬æƒ³åœ¨ Rust ä¸­ä½¿ç”¨å®ƒçš„æ—¶å€™ï¼Œå¯ä»¥å…ˆæ’°å†™ä¸€äº›ç®€å•çš„ shim ä»£ç ï¼ŒæŠŠæƒ³è¦æš´éœ²å‡ºæ¥çš„æ¥å£æš´éœ²å‡ºæ¥ï¼Œç„¶åä½¿ç”¨ bindgen æ¥ç”Ÿæˆå¯¹åº”çš„ Rust FFI ä»£ç ã€‚</p><p>bindgen ä¼šç”Ÿæˆä½å±‚çš„ Rust APIï¼ŒRust ä¸‹çº¦å®šä¿—æˆçš„æ–¹å¼æ˜¯å°†ä½¿ç”¨ bindgen çš„ crate å‘½åä¸º xxx-sysï¼Œé‡Œé¢åŒ…å«å› ä¸º FFI è€Œå¯¼è‡´çš„å¤§é‡ unsafe ä»£ç ã€‚ç„¶åï¼Œåœ¨è¿™ä¸ªåŸºç¡€ä¸Šç”Ÿæˆ xxx crateï¼Œç”¨æ›´é«˜å±‚çš„ä»£ç æ¥å°è£…è¿™äº›ä½å±‚çš„ä»£ç ï¼Œä¸ºå…¶å®ƒ Rust å¼€å‘è€…æä¾›ä¸€å¥—æ„Ÿè§‰æ›´åŠ  Rusty çš„ä»£ç ã€‚</p><p>æ¯”å¦‚ï¼Œå›´ç»•ç€ä½å±‚çš„æ•°æ®ç»“æ„å’Œå‡½æ•°ï¼Œæä¾› Rust è‡ªå·±çš„ struct/enum/trait æ¥å£ã€‚-</p><p>æˆ‘ä»¬ä»¥ä½¿ç”¨ bindgen æ¥å°è£…ç”¨äºå‹ç¼©/è§£å‹ç¼©çš„ bz2 ä¸ºä¾‹ï¼Œçœ‹çœ‹ Rust å¦‚ä½•è°ƒç”¨ C çš„åº“ï¼ˆä»¥ä¸‹ä»£ç è¯·åœ¨ OS X/Linux ä¸‹æµ‹è¯•ï¼Œä½¿ç”¨ Windows çš„åŒå­¦å¯ä»¥å‚è€ƒ bzip2-sysï¼‰ã€‚</p><p>é¦–å…ˆ cargo new bzlib-sys â€“lib åˆ›å»ºä¸€ä¸ªé¡¹ç›®ï¼Œç„¶ååœ¨ Cargo.toml ä¸­æ·»å…¥ï¼š</p><div class="language-text vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>[dependencies]</span></span>\n<span class="line"><span>anyhow = &quot;1&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-text vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>[build-dependencies]</span></span>\n<span class="line"><span>bindgen = &quot;0.59&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>å…¶ä¸­ bindgen éœ€è¦åœ¨ç¼–è¯‘æœŸä½¿ç”¨ï¼Œ æ‰€ä»¥æˆ‘ä»¬åœ¨æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª build.rs ä½¿å…¶åœ¨ç¼–è¯‘æœŸè¿è¡Œï¼š</p><div class="language-text vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>fn main() {</span></span>\n<span class="line"><span>    // å‘Šè¯‰ rustc éœ€è¦ link bzip2</span></span>\n<span class="line"><span>    println!(&quot;cargo:rustc-link-lib=bz2&quot;);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-text vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>    // å‘Šè¯‰ cargo å½“ wrapper.h å˜åŒ–æ—¶é‡æ–°è¿è¡Œ</span></span>\n<span class="line"><span>    println!(&quot;cargo:rerun-if-changed=wrapper.h&quot;);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // é…ç½® bindgenï¼Œå¹¶ç”Ÿæˆ Bindings ç»“æ„</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bindings </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bindgen::Builder::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">default</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">header</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;wrapper.h&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">parse_callbacks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Box::</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">bindgen</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">CargoCallbacks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        .generate()</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        .expect(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Unable to generate bindings&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-text vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>    // ç”Ÿæˆ Rust ä»£ç </span></span>\n<span class="line"><span>    bindings</span></span>\n<span class="line"><span>        .write_to_file(&quot;src/bindings.rs&quot;)</span></span>\n<span class="line"><span>        .expect(&quot;Failed to write bindings&quot;);</span></span>\n<span class="line"><span>}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>åœ¨ build.rs é‡Œï¼Œå¼•å…¥äº†ä¸€ä¸ª wrapper.hï¼Œæˆ‘ä»¬åœ¨æ ¹ç›®å½•åˆ›å»ºå®ƒï¼Œå¹¶å¼•ç”¨ bzlib.hï¼š</p><h1 id="include-bzlib-h" tabindex="-1">include &lt;bzlib.h&gt; <a class="header-anchor" href="#include-bzlib-h" aria-label="Permalink to &quot;include &lt;bzlib.h&gt;&quot;">â€‹</a></h1><p>æ­¤æ—¶è¿è¡Œ cargo buildï¼Œä¼šåœ¨ src ç›®å½•ä¸‹ç”Ÿæˆ src/bindings.rsï¼Œé‡Œé¢å¤§æ¦‚æœ‰ä¸¤åƒè¡Œä»£ç ï¼Œæ˜¯ bindgen æ ¹æ® bzlib.h ä¸­æš´éœ²çš„å¸¸é‡å®šä¹‰ã€æ•°æ®ç»“æ„å’Œå‡½æ•°ç­‰ç”Ÿæˆçš„ Rust ä»£ç ã€‚æ„Ÿå…´è¶£çš„è¯ï¼Œä½ å¯ä»¥çœ‹çœ‹ã€‚</p><p>æœ‰äº†ç”Ÿæˆå¥½çš„ä»£ç ï¼Œæˆ‘ä»¬åœ¨ src/lib.rs ä¸­å¼•ç”¨å®ƒï¼š</p><p>// ç”Ÿæˆçš„ bindings ä»£ç æ ¹æ® C/C++ ä»£ç ç”Ÿæˆï¼Œé‡Œé¢æœ‰ä¸€äº›ä¸ç¬¦åˆ Rust çº¦å®šï¼Œæˆ‘ä»¬ä¸è®©ç¼–è¯‘æœŸæŠ¥è­¦</p><h1 id="allow-non-upper-case-globals" tabindex="-1">![allow(non_upper_case_globals)] <a class="header-anchor" href="#allow-non-upper-case-globals" aria-label="Permalink to &quot;![allow(non_upper_case_globals)]&quot;">â€‹</a></h1><h1 id="allow-non-camel-case-types" tabindex="-1">![allow(non_camel_case_types)] <a class="header-anchor" href="#allow-non-camel-case-types" aria-label="Permalink to &quot;![allow(non_camel_case_types)]&quot;">â€‹</a></h1><h1 id="allow-non-snake-case" tabindex="-1">![allow(non_snake_case)] <a class="header-anchor" href="#allow-non-snake-case" aria-label="Permalink to &quot;![allow(non_snake_case)]&quot;">â€‹</a></h1><h1 id="allow-deref-nullptr" tabindex="-1">![allow(deref_nullptr)] <a class="header-anchor" href="#allow-deref-nullptr" aria-label="Permalink to &quot;![allow(deref_nullptr)]&quot;">â€‹</a></h1><div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">use </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">anyhow</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::{anyhow, Result};</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">use </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">std</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::mem;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>mod bindings;</p><p>pub use bindings:ğŸ˜—;</p><p>æ¥ä¸‹æ¥å°±å¯ä»¥æ’°å†™ä¸¤ä¸ªé«˜é˜¶çš„æ¥å£ compress/decompressï¼Œæ­£å¸¸æƒ…å†µä¸‹åº”è¯¥åˆ›å»ºå¦ä¸€ä¸ª crate æ¥æ’°å†™è¿™æ ·çš„æ¥å£ï¼Œä¹‹å‰è®²è¿™æ˜¯ Rust å¤„ç† FFI çš„æƒ¯ä¾‹ï¼Œæœ‰åŠ©äºæŠŠé«˜é˜¶æ¥å£å’Œä½é˜¶æ¥å£åˆ†ç¦»ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°±ç›´æ¥å†™åœ¨ src/lib.rs ä¸­ï¼š</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// é«˜å±‚çš„ APIï¼Œå¤„ç†å‹ç¼©ï¼Œä¸€èˆ¬åº”è¯¥å‡ºç°åœ¨å¦ä¸€ä¸ª crate</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">pub fn </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">compress</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(input: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[u8]) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Vec</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">u8</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    let output </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> vec</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[0u8; input.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">len</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()];</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    unsafe {</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mut stream</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bz_stream</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mem::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">zeroed</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BZ2_bzCompressInit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">mut stream </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> *</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mut</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> _</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> BZ_OK</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> _</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">            return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Err</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">anyhow</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">!(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Failed to initialize&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // ä¼ å…¥ input/output è¿›è¡Œå‹ç¼©</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        stream.next_in </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> input.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">as_ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> *</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mut</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> _</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        stream.avail_in </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> input.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">len</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> _</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        stream.next_out </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> output.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">as_ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> *</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mut</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> _</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        stream.avail_out </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> output.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">len</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> _</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BZ2_bzCompress</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">mut stream </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> *</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mut</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> _</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">BZ_FINISH</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> _</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> BZ_STREAM_END</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> _</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">            return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Err</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">anyhow</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">!(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Failed to compress&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // ç»“æŸå‹ç¼©</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BZ2_bzCompressEnd</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">mut stream </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> *</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mut</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> _</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> BZ_OK</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> _</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">            return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Err</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">anyhow</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">!(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Failed to end compression&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-text vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>    Ok(output)</span></span>\n<span class="line"><span>}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// é«˜å±‚çš„ APIï¼Œå¤„ç†è§£å‹ç¼©ï¼Œä¸€èˆ¬åº”è¯¥å‡ºç°åœ¨å¦ä¸€ä¸ª crate</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">pub fn </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">decompress</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(input: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[u8]) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Result</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Vec</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">u8</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    let output </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> vec</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[0u8; input.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">len</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()];</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    unsafe {</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mut stream</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bz_stream</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mem::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">zeroed</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BZ2_bzDecompressInit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">mut stream </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> *</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mut</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> _</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> BZ_OK</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> _</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">            return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Err</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">anyhow</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">!(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Failed to initialize&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // ä¼ å…¥ input/output è¿›è¡Œè§£å‹ç¼©</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        stream.next_in </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> input.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">as_ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> *</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mut</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> _</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        stream.avail_in </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> input.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">len</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> _</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        stream.next_out </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> output.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">as_ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> *</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mut</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> _</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        stream.avail_out </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> output.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">len</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> _</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BZ2_bzDecompress</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">mut stream </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> *</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mut</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> _</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> BZ_STREAM_END</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> _</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">            return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Err</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">anyhow</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">!(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Failed to compress&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // ç»“æŸè§£å‹ç¼©</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BZ2_bzDecompressEnd</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">mut stream </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> *</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mut</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> _</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> BZ_OK</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> _</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">            return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Err</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">anyhow</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">!(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Failed to end compression&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-text vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>    Ok(output)</span></span>\n<span class="line"><span>}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>æœ€åï¼Œä¸è¦å¿˜è®°äº†æˆ‘ä»¬çš„å¥½ä¹ æƒ¯ï¼Œå†™ä¸ªæµ‹è¯•ç¡®ä¿å·¥ä½œæ­£å¸¸ï¼š</p><h1 id="cfg-test" tabindex="-1">[cfg(test)] <a class="header-anchor" href="#cfg-test" aria-label="Permalink to &quot;[cfg(test)]&quot;">â€‹</a></h1><div class="language-css vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">css</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">mod tests {</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    use</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> super</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::*;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    #[test]</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    fn </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">compression_decompression_should_work</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> input </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> include_str</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;bindings.rs&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">as_bytes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> compressed </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> compress</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(input).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">unwrap</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> decompressed </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> decompress</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">compressed).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">unwrap</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-text vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>        assert_eq!(input, &amp;decompressed);</span></span>\n<span class="line"><span>    }</span></span>\n<span class="line"><span>}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>è¿è¡Œ cargo testï¼Œæµ‹è¯•èƒ½å¤Ÿæ­£å¸¸é€šè¿‡ã€‚ä½ å¯ä»¥çœ‹åˆ°ï¼Œç”Ÿæˆçš„ bindings.rs é‡Œä¹Ÿæœ‰ä¸å°‘æµ‹è¯•ï¼Œcargo test æ€»å…±æ‰§è¡Œäº† 16 ä¸ªæµ‹è¯•ã€‚</p><p>æ€ä¹ˆæ ·ï¼Œæˆ‘ä»¬æ€»å…±å†™äº†å¤§æ¦‚ 100 è¡Œä»£ç ï¼Œå°±ç”¨ Rust é›†æˆäº† bz2 è¿™ä¸ª C åº“ã€‚æ˜¯ä¸æ˜¯éå¸¸æ–¹ä¾¿ï¼Ÿå¦‚æœä½ æ›¾ç»å¤„ç†è¿‡å…¶ä»–è¯­è¨€ç±»ä¼¼çš„ C ç»‘å®šï¼Œå¯¹æ¯”ä¹‹ä¸‹ï¼Œå°±ä¼šå‘ç°ç”¨ Rust åš FFI å¼€å‘çœŸæ˜¯å¤ªæ–¹ä¾¿ï¼Œå¤ªè´´å¿ƒäº†ã€‚</p><p>å¦‚æœä½ è§‰å¾—è¿™ä¸ªä¾‹å­è¿‡äºç®€å•ï¼Œä¸å¤Ÿè¿‡ç˜¾ï¼Œå¯ä»¥çœ‹çœ‹ Rust RocksDB çš„å®ç°ï¼Œå®ƒéå¸¸é€‚åˆä½ è¿›ä¸€æ­¥äº†è§£å¤æ‚çš„ã€éœ€è¦é¢å¤–é›†æˆ C æºç çš„åº“å¦‚ä½•é›†æˆåˆ° Rust ä¸­ã€‚</p><p>å¤„ç† FFI çš„æ³¨æ„äº‹é¡¹</p><p>bindgen è¿™æ ·çš„å·¥å…·ï¼Œå¸®æˆ‘ä»¬å¹²äº†å¾ˆå¤šè„æ´»ç´¯æ´»ï¼Œè™½ç„¶å¤§éƒ¨åˆ†æ—¶å€™æˆ‘ä»¬ä¸å¤ªéœ€è¦å…³å¿ƒç”Ÿæˆçš„ FFI ä»£ç ï¼Œä½†åœ¨ä½¿ç”¨å®ƒä»¬æ„å»ºæ›´é«˜å±‚çš„ API æ—¶ï¼Œè¿˜æ˜¯è¦æ³¨æ„ä¸‰ä¸ªå…³é”®é—®é¢˜ã€‚</p><p>å¦‚ä½•å¤„ç†æ•°æ®ç»“æ„çš„å·®å¼‚ï¼Ÿ</p><p>æ¯”å¦‚ C string æ˜¯ NULL ç»“å°¾ï¼Œè€Œ Rust String æ˜¯å®Œå…¨ä¸åŒçš„ç»“æ„ã€‚æˆ‘ä»¬è¦æ¸…æ¥šæ•°æ®ç»“æ„åœ¨å†…å­˜ä¸­ç»„ç»‡çš„å·®å¼‚ï¼Œæ‰èƒ½å¦¥å–„åœ°å¤„ç†å®ƒä»¬ã€‚Rust æä¾›äº† std::ffi æ¥å¤„ç†è¿™æ ·çš„é—®é¢˜ï¼Œæ¯”å¦‚ CStr å’Œ CString æ¥å¤„ç†å­—ç¬¦ä¸²ã€‚</p><p>è°æ¥é‡Šæ”¾å†…å­˜ï¼Ÿ</p><p>æ²¡æœ‰ç‰¹æ®Šçš„æƒ…å†µï¼Œè°åˆ†é…çš„å†…å­˜ï¼Œè°è¦è´Ÿè´£é‡Šæ”¾ã€‚Rust çš„å†…å­˜åˆ†é…å™¨å’Œå…¶å®ƒè¯­è¨€çš„å¯èƒ½ä¸ä¸€æ ·ï¼Œæ‰€ä»¥ï¼ŒRust åˆ†é…çš„å†…å­˜åœ¨ C çš„ä¸Šä¸‹æ–‡ä¸­é‡Šæ”¾ï¼Œå¯èƒ½ä¼šå¯¼è‡´æœªå®šä¹‰çš„è¡Œä¸ºã€‚</p><p>å¦‚ä½•è¿›è¡Œé”™è¯¯å¤„ç†ï¼Ÿ</p><p>åœ¨ä¸Šé¢çš„ä»£ç é‡Œæˆ‘ä»¬ä¹Ÿçœ‹åˆ°äº†ï¼ŒC é€šè¿‡è¿”å›çš„ error code æ¥æŠ¥å‘Šæ‰§è¡Œè¿‡ç¨‹ä¸­çš„é”™è¯¯ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† anyhow! å®æ¥éšæ‰‹ç”Ÿæˆäº†é”™è¯¯ï¼Œè¿™æ˜¯ä¸å¥½çš„ç¤ºä¾‹ã€‚åœ¨æ­£å¼çš„ä»£ç ä¸­ï¼Œåº”è¯¥ä½¿ç”¨ thiserror æˆ–è€…ç±»ä¼¼çš„æœºåˆ¶æ¥å®šä¹‰æ‰€æœ‰ error code å¯¹åº”çš„é”™è¯¯æƒ…å†µï¼Œç„¶åç›¸åº”åœ°ç”Ÿæˆé”™è¯¯ã€‚</p><p>Rust è°ƒç”¨å…¶å®ƒè¯­è¨€</p><p>ç›®å‰è¯´äº†åŠå¤©ï¼Œéƒ½æ˜¯åœ¨è¯´ Rust å¦‚ä½•è°ƒç”¨ C/C++ã€‚é‚£ä¹ˆï¼ŒRustï¼Œè°ƒç”¨å…¶ä»–è¯­è¨€å‘¢ï¼Ÿ</p><p>å‰é¢ä¹Ÿæåˆ°ï¼Œå› ä¸º C ABI æ·±å…¥äººå¿ƒï¼Œä¸¤é—¨è¯­è¨€ä¹‹é—´çš„æ¥å£å¾€å¾€é‡‡ç”¨ C ABIã€‚ä»è¿™ä¸ªè§’åº¦è¯´ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦ Rust è°ƒç”¨ Golang çš„ä»£ç ï¼ˆå…ˆä¸ç®¡è¿™åˆä¸åˆç†ï¼‰ï¼Œé‚£ä¹ˆï¼Œé¦–å…ˆæŠŠ Golang çš„ä»£ç ä½¿ç”¨ cgo ç¼–è¯‘æˆå…¼å®¹ C çš„åº“ï¼›ç„¶åï¼ŒRust å°±å¯ä»¥åƒè°ƒç”¨ C/C++ é‚£æ ·ï¼Œä½¿ç”¨ bindgen æ¥ç”Ÿæˆå¯¹åº”çš„ API äº†ã€‚</p><p>è‡³äº Rust è°ƒç”¨å…¶å®ƒè¯­è¨€ï¼Œä¹Ÿæ˜¯ç±»ä¼¼ï¼Œåªä¸è¿‡åƒ JavaScript/Python è¿™æ ·çš„ï¼Œä¸å…¶æŠŠå®ƒä»¬çš„ä»£ç æƒ³åŠæ³•ç¼–è¯‘æˆ C åº“ï¼Œä¸å¦‚æŠŠä»–ä»¬çš„è§£é‡Šå™¨ç¼–è¯‘æˆ C åº“æˆ–è€… WASMï¼Œç„¶ååœ¨ Rust é‡Œè°ƒç”¨å…¶è§£é‡Šå™¨ä½¿ç”¨ç›¸å…³çš„ä»£ç ï¼Œæ¥çš„æ–¹ä¾¿å’Œç—›å¿«ã€‚æ¯•ç«Ÿï¼ŒJavaScript/Python æ˜¯è„šæœ¬è¯­è¨€ã€‚</p><p>æŠŠ Rust ä»£ç ç¼–è¯‘æˆ C åº“</p><p>è®²å®Œäº† Rust å¦‚ä½•ä½¿ç”¨å…¶å®ƒè¯­è¨€ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹å¦‚ä½•æŠŠ Rust ä»£ç ç¼–è¯‘æˆç¬¦åˆ C ABI çš„åº“ï¼Œè¿™æ ·å…¶å®ƒè¯­è¨€å°±å¯ä»¥åƒä½¿ç”¨ C é‚£æ ·ä½¿ç”¨ Rust äº†ã€‚</p><p>è¿™é‡Œçš„å¤„ç†é€»è¾‘å’Œä¸Šé¢çš„ Rust è°ƒç”¨ C æ˜¯ç±»ä¼¼çš„ï¼Œåªä¸è¿‡è§’è‰²å¯¹è°ƒäº†ä¸€ä¸‹ï¼š-</p><p>è¦æŠŠ Rust ä»£ç å’Œæ•°æ®ç»“æ„æä¾›ç»™ C ä½¿ç”¨ï¼Œæˆ‘ä»¬é¦–å…ˆè¦æ„é€ ç›¸åº”çš„ Rust shim å±‚ï¼ŒæŠŠåŸæœ‰çš„ã€æ­£å¸¸çš„ Rust å®ç°å°è£…ä¸€ä¸‹ï¼Œä¾¿äº C è°ƒç”¨ã€‚</p><p>Rust shim ä¸»è¦åšå››ä»¶äº‹æƒ…ï¼š</p><div class="language-text vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>æä¾› Rust æ–¹æ³•ã€trait æ–¹æ³•ç­‰å…¬å¼€æ¥å£çš„ç‹¬ç«‹å‡½æ•°ã€‚æ³¨æ„ C æ˜¯ä¸æ”¯æŒæ³›å‹çš„ï¼Œæ‰€ä»¥å¯¹äºæ³›å‹å‡½æ•°ï¼Œéœ€è¦æä¾›å…·ä½“çš„ç”¨äºæŸä¸ªç±»å‹çš„ shim å‡½æ•°ã€‚</span></span>\n<span class="line"><span>æ‰€æœ‰è¦æš´éœ²ç»™ C çš„ç‹¬ç«‹å‡½æ•°ï¼Œéƒ½è¦å£°æ˜æˆ #[no_mangle]ï¼Œä¸åšå‡½æ•°åç§°çš„æ”¹å†™ã€‚</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>å¦‚æœä¸ç”¨ #[no_mangle]ï¼ŒRust ç¼–è¯‘å™¨ä¼šä¸ºå‡½æ•°ç”Ÿæˆå¾ˆå¤æ‚çš„åå­—ï¼Œæˆ‘ä»¬å¾ˆéš¾åœ¨ C ä¸­å¾—åˆ°æ­£ç¡®çš„æ”¹å†™åçš„åå­—ã€‚åŒæ—¶ï¼Œè¿™äº›å‡½æ•°çš„æ¥å£è¦ä½¿ç”¨ C å…¼å®¹çš„æ•°æ®ç»“æ„ã€‚</p><p>æ•°æ®ç»“æ„éœ€è¦å¤„ç†æˆå’Œ C å…¼å®¹çš„ç»“æ„ã€‚</p><p>å¦‚æœæ˜¯ä½ è‡ªå·±å®šä¹‰çš„ç»“æ„ä½“ï¼Œéœ€è¦ä½¿ç”¨ #[reprÂ©]ï¼Œå¯¹äºè¦æš´éœ²ç»™ C çš„å‡½æ•°ï¼Œä¸èƒ½ä½¿ç”¨ String/Vec/Result è¿™äº› C æ— æ³•æ­£ç¡®æ“ä½œçš„æ•°æ®ç»“æ„ã€‚</p><p>è¦ä½¿ç”¨ catch_unwind æŠŠæ‰€æœ‰å¯èƒ½äº§ç”Ÿ panic! çš„ä»£ç åŒ…è£¹èµ·æ¥ã€‚</p><p>åˆ‡è®°ï¼Œå…¶å®ƒè¯­è¨€è°ƒç”¨ Rust æ—¶ï¼Œé‡åˆ° Rust çš„ panic!()ï¼Œä¼šå¯¼è‡´æœªå®šä¹‰çš„è¡Œä¸ºï¼Œæ‰€ä»¥åœ¨ FFI çš„è¾¹ç•Œå¤„ï¼Œè¦ catch_unwindï¼Œé˜»æ­¢ Rust æ ˆå›æº¯è·‘å‡º Rust çš„ä¸–ç•Œã€‚</p><p>æ¥çœ‹ä¸ªä¾‹å­ï¼š</p><p>// ä½¿ç”¨ no_mangle ç¦æ­¢å‡½æ•°åæ”¹ç¼–ï¼Œè¿™æ ·å…¶å®ƒè¯­è¨€å¯ä»¥é€šè¿‡ C ABI è°ƒç”¨è¿™ä¸ªå‡½æ•°</p><h1 id="no-mangle" tabindex="-1">[no_mangle] <a class="header-anchor" href="#no-mangle" aria-label="Permalink to &quot;[no_mangle]&quot;">â€‹</a></h1><div class="language-css vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">css</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">pub extern &quot;C&quot; fn hello_world() -</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">const c_char {</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    // </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">C</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ä»¥ &quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\\\</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">0&quot; ç»“å°¾ï¼Œä½ å¯ä»¥æŠŠ &quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\\\</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">0&quot; å»æ‰çœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆ</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">hello</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> world</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">!</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\\\</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">0&quot;.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">_</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> c</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">_</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">char</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>è¿™æ®µä»£ç ä½¿ç”¨äº† #[no_mangle] ï¼Œåœ¨ä¼ å›å»å­—ç¬¦ä¸²æ—¶ä½¿ç”¨ â€œ\\0â€ ç»“å°¾çš„å­—ç¬¦ä¸²ã€‚ç”±äºè¿™ä¸ªå­—ç¬¦ä¸²åœ¨ RODATA æ®µï¼Œæ˜¯ â€˜static çš„ç”Ÿå‘½å‘¨æœŸï¼Œæ‰€ä»¥å°†å…¶è½¬æ¢æˆè£¸æŒ‡é’ˆè¿”å›ï¼Œæ²¡æœ‰é—®é¢˜ã€‚å¦‚æœè¦æŠŠè¿™æ®µä»£ç ç¼–è¯‘ä¸ºä¸€ä¸ªå¯ç”¨çš„ C åº“ï¼Œåœ¨ Cargo.toml ä¸­ï¼Œcrate ç±»å‹è¦è®¾ç½®ä¸º crate-type = [â€œcdylibâ€]ã€‚</p><p>åˆšæ‰é‚£ä¸ªä¾‹å­å¤ªç®€å•ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸ªè¿›é˜¶çš„ä¾‹å­ã€‚åœ¨è¿™ä¸ªä¾‹å­é‡Œï¼ŒC è¯­è¨€é‚£ç«¯ä¼šä¼ è¿‡æ¥ä¸€ä¸ªå­—ç¬¦ä¸²æŒ‡é’ˆï¼Œ format!() ä¸€ä¸‹åï¼Œè¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²æŒ‡é’ˆï¼š</p><h1 id="no-mangle-1" tabindex="-1">[no_mangle] <a class="header-anchor" href="#no-mangle-1" aria-label="Permalink to &quot;[no_mangle]&quot;">â€‹</a></h1><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">pub extern </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;C&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fn </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">hello_bad</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(name: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">const c_char) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> c_char</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> s </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> unsafe { CStr::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">from_ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(name).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">to_str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">unwrap</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() };</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-css vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">css</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    format!(&quot;hello {}!</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\\\</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">0&quot;, </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">s</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">.as_ptr(</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) as </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">const c_char</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>ä½ èƒ½å‘ç°è¿™æ®µä»£ç çš„é—®é¢˜ä¹ˆï¼Ÿå®ƒçŠ¯äº†åˆå­¦è€…å‡ ä¹ä¼šçŠ¯çš„æ‰€æœ‰é—®é¢˜ã€‚</p><p>é¦–å…ˆï¼Œä¼ å…¥çš„ name ä¼šä¸ä¼šæ˜¯ä¸€ä¸ª NULL æŒ‡é’ˆï¼Ÿæ˜¯ä¸æ˜¯ä¸€ä¸ªåˆæ³•çš„åœ°å€ï¼Ÿè™½ç„¶æ˜¯å¦æ˜¯åˆæ³•çš„åœ°å€æˆ‘ä»¬æ— æ³•æ£€æµ‹ï¼Œä½†èµ·ç æˆ‘ä»¬å¯ä»¥æ£€æµ‹ NULLã€‚</p><p>å…¶æ¬¡ï¼Œunwrap() ä¼šé€ æˆ panic!()ï¼Œå¦‚æœæŠŠ CStr è½¬æ¢æˆ &amp;str æ—¶å‡ºç°é”™è¯¯ï¼Œè¿™ä¸ª panic!() å°±ä¼šé€ æˆæœªå®šä¹‰çš„è¡Œä¸ºã€‚æˆ‘ä»¬å¯ä»¥åš catch_unwind()ï¼Œä½†æ›´å¥½çš„æ–¹å¼æ˜¯è¿›è¡Œé”™è¯¯å¤„ç†ã€‚</p><p>æœ€åï¼Œformat!(&quot;hello {}!\\0&quot;, s) ç”Ÿæˆäº†ä¸€ä¸ªå­—ç¬¦ä¸²ç»“æ„ï¼Œas_ptr() å–åˆ°å®ƒå †ä¸Šçš„èµ·å§‹ä½ç½®ï¼Œæˆ‘ä»¬ä¹Ÿä¿è¯äº†å †ä¸Šçš„å†…å­˜ä»¥ NULL ç»“å°¾ï¼Œçœ‹ä¸Šå»æ²¡æœ‰é—®é¢˜ã€‚ç„¶è€Œï¼Œåœ¨è¿™ä¸ªå‡½æ•°ç»“æŸæ‰§è¡Œæ—¶ï¼Œç”±äºå­—ç¬¦ä¸² s é€€å‡ºä½œç”¨åŸŸï¼Œæ‰€ä»¥å®ƒçš„å †å†…å­˜ä¼šè¢«è¿å¸¦ drop æ‰ã€‚å› æ­¤ï¼Œè¿™ä¸ªå‡½æ•°è¿”å›çš„æ˜¯ä¸€ä¸ªæ‚¬ç©ºçš„æŒ‡é’ˆï¼Œåœ¨ C é‚£ä¾§è°ƒç”¨æ—¶å°±ä¼šå´©æºƒã€‚</p><p>æ‰€ä»¥ï¼Œæ­£ç¡®çš„å†™æ³•åº”è¯¥æ˜¯ï¼š</p><h1 id="no-mangle-2" tabindex="-1">[no_mangle] <a class="header-anchor" href="#no-mangle-2" aria-label="Permalink to &quot;[no_mangle]&quot;">â€‹</a></h1><div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">pub </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">extern</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;C&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fn </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">hello</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(name: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> c_char) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> c_char {</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> name.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">is_null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Ok(s) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> unsafe { CStr::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">from_ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(name).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">to_str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() } {</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        let result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> format</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;hello {}!&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, s);</span></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // å¯ä»¥ä½¿ç”¨ unwrapï¼Œå› ä¸º result ä¸åŒ…å« \\\\0</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        let s </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> CString::</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(result).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">unwrap</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        s.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">into_raw</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // ç›¸å½“äºï¼š</span></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // let p = s.as_ptr();</span></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // std::mem::forget(s);</span></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // p</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>åœ¨è¿™æ®µä»£ç é‡Œï¼Œæˆ‘ä»¬æ£€æŸ¥äº† NULL æŒ‡é’ˆï¼Œè¿›è¡Œäº†é”™è¯¯å¤„ç†ï¼Œè¿˜ç”¨ into_raw() æ¥è®© Rust ä¾§æ”¾å¼ƒå¯¹å†…å­˜çš„æ‰€æœ‰æƒã€‚</p><p>æ³¨æ„å‰é¢çš„ä¸‰ä¸ªå…³é”®é—®é¢˜è¯´è¿‡ï¼Œè°åˆ†é…çš„å†…å­˜ï¼Œè°æ¥é‡Šæ”¾ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æä¾›å¦ä¸€ä¸ªå‡½æ•°ï¼Œä¾› C è¯­è¨€ä¾§ä½¿ç”¨ï¼Œæ¥é‡Šæ”¾ Rust åˆ†é…çš„å­—ç¬¦ä¸²ï¼š</p><h1 id="no-mangle-3" tabindex="-1">[no_mangle] <a class="header-anchor" href="#no-mangle-3" aria-label="Permalink to &quot;[no_mangle]&quot;">â€‹</a></h1><div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">pub </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">extern</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;C&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fn </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">free_str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(s: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">mut c_char) {</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">s.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">is_null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        unsafe { </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">CString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">from_raw</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(s) };</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>C ä»£ç å¿…é¡»è¦è°ƒç”¨è¿™ä¸ªæ¥å£å®‰å…¨é‡Šæ”¾ Rust åˆ›å»ºçš„ CStringã€‚å¦‚æœä¸è°ƒç”¨ï¼Œä¼šæœ‰å†…å­˜æ³„æ¼ï¼›å¦‚æœä½¿ç”¨ C è‡ªå·±çš„ free()ï¼Œä¼šå¯¼è‡´æœªå®šä¹‰çš„é”™è¯¯ã€‚</p><p>æœ‰äººå¯èƒ½ä¼šå¥½å¥‡ï¼ŒCString::from_raw(s) åªæ˜¯ä»è£¸æŒ‡é’ˆä¸­æ¢å¤å‡º CStringï¼Œä¹Ÿæ²¡æœ‰é‡Šæ”¾å•Šï¼Ÿ</p><p>ä½ è¦ä¹ æƒ¯è¿™æ ·çš„â€œé‡Šæ”¾å†…å­˜â€çš„å†™æ³•ï¼Œå› ä¸ºå®ƒå®é™…ä¸Šå€ŸåŠ©äº† Rust çš„æ‰€æœ‰æƒè§„åˆ™ï¼šå½“æ‰€æœ‰è€…ç¦»å¼€ä½œç”¨åŸŸæ—¶ï¼Œæ‹¥æœ‰çš„å†…å­˜ä¼šè¢«é‡Šæ”¾ã€‚è¿™é‡Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæœ‰æ‰€æœ‰æƒçš„å¯¹è±¡ï¼Œå°±æ˜¯ä¸ºäº†å‡½æ•°ç»“æŸæ—¶çš„è‡ªåŠ¨é‡Šæ”¾ã€‚å¦‚æœä½ çœ‹æ ‡å‡†åº“æˆ–ç¬¬ä¸‰æ–¹åº“ï¼Œç»å¸¸æœ‰ç±»ä¼¼çš„â€œé‡Šæ”¾å†…å­˜â€çš„ä»£ç ã€‚</p><p>ä¸Šé¢çš„ hello ä»£ç ï¼Œå…¶å®è¿˜ä¸å¤Ÿå®‰å…¨ã€‚å› ä¸ºè™½ç„¶çœ‹ä¸Šå»æ²¡æœ‰ä½¿ç”¨ä»»ä½•ä¼šå¯¼è‡´ç›´æ¥æˆ–è€…é—´æ¥ panic! çš„ä»£ç ï¼Œä½†éš¾ä¿ä»£ç å¤æ‚åï¼Œéšå¼åœ°è°ƒç”¨äº† panic!()ã€‚æ¯”å¦‚ï¼Œå¦‚æœä»¥åæˆ‘ä»¬æ–°åŠ ä¸€äº›é€»è¾‘ï¼Œä½¿ç”¨äº† copy_from_slice()ï¼Œè¿™ä¸ªå‡½æ•°å†…éƒ¨ä¼šè°ƒç”¨ panic!()ï¼Œå°±ä¼šå¯¼è‡´é—®é¢˜ã€‚æ‰€ä»¥ï¼Œæœ€å¥½çš„æ–¹æ³•æ˜¯æŠŠä¸»è¦çš„é€»è¾‘å°è£…åœ¨ catch_unwind é‡Œï¼š</p><h1 id="no-mangle-4" tabindex="-1">[no_mangle] <a class="header-anchor" href="#no-mangle-4" aria-label="Permalink to &quot;[no_mangle]&quot;">â€‹</a></h1><div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">pub </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">extern</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;C&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fn </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">hello</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(name: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> c_char) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> c_char {</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> name.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">is_null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> catch_unwind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        if let </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Ok</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">s</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) = unsafe { </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">CStr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">from_ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(name).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">to_str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() } {</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> format</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;hello {}!&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, s);</span></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // å¯ä»¥ä½¿ç”¨ unwrapï¼Œå› ä¸º result ä¸åŒ…å« \\\\0</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> s </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> CString::</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(result).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">unwrap</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            s.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">into_raw</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">            ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    });</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    match result {</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        Ok</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(s) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> s,</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        Err</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(_) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>è¿™å‡ æ®µä»£ç ä½ å¯ä»¥å¤šå¤šä½“ä¼šï¼Œå®Œæ•´ä¾‹å­æ”¾åœ¨ playgroundã€‚</p><p>å†™å¥½ Rust shim ä»£ç åï¼Œæ¥ä¸‹æ¥å°±æ˜¯ç”Ÿæˆ C çš„ FFI æ¥å£äº†ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè¿™ä¸ªç¯èŠ‚å¯ä»¥ç”¨å·¥å…·æ¥è‡ªåŠ¨ç”Ÿæˆã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ cbindgenã€‚å¦‚æœä½¿ç”¨ cbindgenï¼Œä¸Šè¿°çš„ä»£ç ä¼šç”Ÿæˆç±»ä¼¼è¿™æ ·çš„ bindings.hï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># include &lt;cstdarg&gt;</span></span>\n<span class="line"><span># include &lt;cstdint&gt;</span></span>\n<span class="line"><span># include &lt;cstdlib&gt;</span></span>\n<span class="line"><span># include &lt;ostream&gt;</span></span>\n<span class="line"><span># include &lt;new&gt;</span></span>\n<span class="line"><span></span></span>\n<span class="line"><span>extern &quot;C&quot; {</span></span>\n<span class="line"><span></span></span>\n<span class="line"><span>const char *hello_world();</span></span>\n<span class="line"><span></span></span>\n<span class="line"><span>const char *hello_bad(const char*name);</span></span>\n<span class="line"><span></span></span>\n<span class="line"><span>const char *hello(const char*name);</span></span>\n<span class="line"><span></span></span>\n<span class="line"><span>void free_str(char *s);</span></span>\n<span class="line"><span></span></span>\n<span class="line"><span>} // extern &quot;C&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>æœ‰äº†ç¼–è¯‘å¥½çš„åº“ä»£ç ä»¥åŠå¤´æ–‡ä»¶åï¼Œåœ¨å…¶ä»–è¯­è¨€ä¸­ï¼Œå°±å¯ä»¥ç”¨è¯¥è¯­è¨€çš„å·¥å…·è¿›ä¸€æ­¥ç”Ÿæˆé‚£é—¨è¯­è¨€çš„ FFI ç»‘å®šï¼Œç„¶åæ­£å¸¸ä½¿ç”¨ã€‚</p><p>å’Œå…¶å®ƒè¯­è¨€çš„äº’æ“ä½œ</p><p>å¥½ï¼Œææ˜ç™½ Rust ä»£ç å¦‚ä½•ç¼–è¯‘æˆ C åº“ä¾› C/C++ å’Œå…¶å®ƒè¯­è¨€ä½¿ç”¨ï¼Œæˆ‘ä»¬å†çœ‹çœ‹å…·ä½“è¯­è¨€æœ‰æ²¡æœ‰é¢å¤–çš„å·¥å…·æ›´æ–¹ä¾¿åœ°å’Œ Rust äº’æ“ä½œã€‚</p><p>å¯¹äº Python å’Œ Node.jsï¼Œæˆ‘ä»¬ä¹‹å‰å·²ç»è§åˆ°äº† PyO3 å’Œ Neon è¿™ä¸¤ä¸ªåº“ï¼Œç”¨èµ·æ¥éƒ½éå¸¸ç®€å•ç›´è§‚ï¼Œä¸‹ä¸€è®²ä¼šå†æ·±å…¥ä½¿ç”¨ä¸€ä¸‹ã€‚</p><p>å¯¹äº Erlang/Elixirï¼Œå¯ä»¥ä½¿ç”¨éå¸¸ä¸é”™çš„ rustlerã€‚å¦‚æœä½ å¯¹æ­¤æ„Ÿå…´è¶£ï¼Œå¯ä»¥çœ‹è¿™ä¸ª repo ä¸­çš„æ¼”ç¤ºæ–‡ç¨¿å’Œä¾‹å­ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªæŠŠ Rust ä»£ç å®‰å…¨åœ°ç»™ Erlang/Elixir ä½¿ç”¨çš„ç®€å•ä¾‹å­ï¼š</p><h1 id="rustler-nif" tabindex="-1">[rustler::nif] <a class="header-anchor" href="#rustler-nif" aria-label="Permalink to &quot;[rustler::nif]&quot;">â€‹</a></h1><div class="language-css vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">css</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">fn add(</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: i64, </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: i64) -</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i64 {</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> + </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">b</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>rustler::init!(&quot;Elixir.Math&quot;, [add]);</p><p>å¯¹äº C++ï¼Œè™½ç„¶ cbindgen å°±è¶³å¤Ÿï¼Œä½†ç¤¾åŒºé‡Œè¿˜æœ‰ cxxï¼Œå®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬å¾ˆæ–¹ä¾¿åœ°å¯¹ Rust å’Œ C++ è¿›è¡Œäº’æ“ä½œã€‚</p><p>å¦‚æœä½ è¦åš Kotlin/Swift å¼€å‘ï¼Œå¯ä»¥å°è¯•ä¸€ä¸‹ mozilla ç”¨åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹çš„ uniffiã€‚ä½¿ç”¨ uniffiï¼Œä½ éœ€è¦å®šä¹‰ä¸€ä¸ª UDLï¼Œè¿™æ · uniffi-bindgen ä¼šå¸®ä½ ç”Ÿæˆå„ç§è¯­è¨€çš„ FFI ä»£ç ã€‚</p><p>å…·ä½“æ€ä¹ˆç”¨å¯ä»¥çœ‹è¿™é—¨è¯¾çš„ GitHub repo ä¸‹è¿™ä¸€è®²çš„ ffi-math crate çš„å®Œæ•´ä»£ç ã€‚è¿™é‡Œå°±è®²ä¸€ä¸‹é‡ç‚¹ï¼Œæˆ‘å†™äº†ä¸ªç®€å•çš„ uniffi æ¥å£ï¼ˆmath.udlï¼‰ï¼š</p><div class="language-css vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">css</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">namespace </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">math</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    u</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">32 </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">u</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">32 </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">u</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">32 </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    string</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> hello</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ByRef</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">string</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>å¹¶æä¾›äº† Rust å®ç°ï¼š</p><p>uniffi_macros::include_scaffolding!(&quot;math&quot;);</p><div class="language-css vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">css</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">pub fn add(</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: u32, </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: u32) -</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> u32 {</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> + </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">b</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-css vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">css</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">pub fn hello(name: &amp;str) -</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String {</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    format</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">!(&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">hello</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {}!&quot;, name)</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>ä¹‹åå°±å¯ä»¥ç”¨ï¼š</p><div class="language-text vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>uniffi-bindgen generate src/math.udl --language swift</span></span>\n<span class="line"><span>uniffi-bindgen generate src/math.udl --language kotlin</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>ç”Ÿæˆå¯¹åº”çš„ Swift å’Œ Kotlin ä»£ç ã€‚</p><p>æˆ‘ä»¬çœ‹ç”Ÿæˆçš„ hello() å‡½æ•°çš„ä»£ç ã€‚æ¯”å¦‚ Kotlin ä»£ç ï¼š</p><div class="language-css vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">css</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">fun hello(name: String): String {</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> val</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">retval</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> =</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  rustCall</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">status</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   _</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">UniFFILib</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">INSTANCE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">math</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">_6</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">c</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">3</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">d</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">_</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">hello</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">lower</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">status</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> return String.lift(_retval)</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>å†æ¯”å¦‚ Swift ä»£ç ï¼š</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">public func </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">hello</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(name: String) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String {</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _retval </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> try</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-css vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">css</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        rustCall {</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            math</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">_6</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">c</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">3</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">d</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">_</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">hello</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">lower</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), $0)</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    return try! String.lift(_retval)</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>ä½ ä¹Ÿè®¸æ³¨æ„åˆ°äº†è¿™ä¸ª RustCallï¼Œå®ƒæ˜¯ç”¨æ¥è°ƒç”¨ Rust FFI ä»£ç çš„ï¼Œçœ‹æºç ï¼š</p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> func rustCall</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">T</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(_ callback</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (UnsafeMutablePointer</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">RustCallStatus</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> T) throws </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> T {</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> makeRustCall(callback, errorHandler</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        $0.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">deallocate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> UniffiInternalError.unexpectedRustCallError</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    })</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">private func </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">makeRustCall</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">T</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;(_ callback: (UnsafeMutablePointer</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">RustCallStatus</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> T</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, errorHandler: (RustBuffer) throws </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Error) throws </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> T</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    var</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> callStatus </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> RustCallStatus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> returnedVal </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> callback</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">callStatus)</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    switch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> callStatus.code {</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    case</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CALL_SUCCESS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> returnedVal</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-text vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>    case CALL_ERROR:</span></span>\n<span class="line"><span>        throw try errorHandler(callStatus.errorBuf)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-css vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">css</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    case CALL_PANIC:</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        // When the rust </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">code</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sees </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> panic, it tries to construct </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> RustBuffer</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        // with the message.  But if that </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">code</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> panics, then it just sends back</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        // an empty buffer.</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        if callStatus</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.errorBuf.len</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 0 {</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            throw</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> UniffiInternalError</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">rustPanic</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">try</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">lift</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">callStatus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">errorBuf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        } else {</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            callStatus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">errorBuf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">deallocate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            throw</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> UniffiInternalError</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">rustPanic</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Rust</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> panic</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&quot;)</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="language-text vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>    default:</span></span>\n<span class="line"><span>        throw UniffiInternalError.unexpectedRustCallStatusCode</span></span>\n<span class="line"><span>    }</span></span>\n<span class="line"><span>}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>ä½ å¯ä»¥çœ‹åˆ°ï¼Œå®ƒè¿˜è€ƒè™‘äº†å¦‚æœ Rust ä»£ç  panic! åçš„å¤„ç†ã€‚é‚£ä¹ˆ Rust ç”³è¯·çš„å†…å­˜ä¼šè¢« Rust é‡Šæ”¾ä¹ˆï¼Ÿ</p><p>ä¼šçš„ã€‚hello() é‡Œçš„ String.lift() å°±åœ¨åšè¿™ä¸ªäº‹æƒ…ï¼Œæˆ‘ä»¬çœ‹ç”Ÿæˆçš„ä»£ç ï¼š</p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">extension String</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ViaFfi {</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    fileprivate typealias FfiType </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> RustBuffer</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    fileprivate static func </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lift</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(_ v: FfiType) throws </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Self {</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        defer {</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            v.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">deallocate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> v.data </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> nil {</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bytes </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> UnsafeBufferPointer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">UInt8</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;(start: v.data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, count: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(v.len))</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(bytes: bytes, encoding: String.Encoding.utf8)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    ...</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> extension RustBuffer {</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ...</span></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Frees the buffer in place.</span></span>\n<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // The buffer must not be used after this is called.</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    func </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">deallocate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">! rustCall { </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ffi_math_6c3d_rustbuffer_free</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(self, $0) }</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>åœ¨ lift æ—¶ï¼Œå®ƒä¼šåˆ†é…ä¸€ä¸ª swift Stringï¼Œç„¶ååœ¨å‡½æ•°é€€å‡ºæ—¶è°ƒç”¨ deallocate()ï¼Œæ­¤æ—¶ä¼šå‘é€ä¸€ä¸ª rustCall ç»™ ffi_math_rustbuffer_free()ã€‚</p><p>ä½ çœ‹ï¼Œuniffi æŠŠå‰é¢è¯´çš„å¤„ç† FFI çš„ä¸‰ä¸ªå…³é”®é—®é¢˜ï¼šå¤„ç†æ•°æ®ç»“æ„çš„å·®å¼‚ã€é‡Šæ”¾å†…å­˜ã€é”™è¯¯å¤„ç†ï¼Œéƒ½å¦¥å–„åœ°è§£å†³äº†ã€‚æ‰€ä»¥ï¼Œå¦‚æœä½ è¦åœ¨ Swift/Kotlin ä»£ç ä¸­ä½¿ç”¨ Rustï¼Œéå¸¸å»ºè®®ä½ ä½¿ç”¨ uniffiã€‚æ­¤å¤–ï¼Œuniffi è¿˜æ”¯æŒ Python å’Œ Rubyã€‚</p><p>FFI çš„å…¶å®ƒæ–¹å¼</p><p>æœ€åï¼Œæˆ‘ä»¬æ¥ç®€å•èŠä¸€èŠå¤„ç† FFI çš„å…¶å®ƒæ–¹å¼ã€‚å…¶å®ä»£ç çš„è·¨è¯­è¨€å…±äº«å¹¶éåªæœ‰ FFI ä¸€æ¡è·¯å­ã€‚ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ REST APIã€gRPC æ¥è¾¾åˆ°ä»£ç è·¨è¯­è¨€ä½¿ç”¨çš„ç›®çš„ã€‚ä¸è¿‡ï¼Œè¿™æ ·è¦é¢å¤–èµ°ä¸€åœˆç½‘ç»œï¼Œå³ä¾¿æ˜¯æœ¬åœ°ç½‘ç»œï¼Œä¹Ÿæ•ˆç‡å¤ªä½ï¼Œä¸”ä¸å¤Ÿå®‰å…¨ã€‚æœ‰æ²¡æœ‰æ›´é«˜æ•ˆä¸€äº›çš„æ–¹æ³•ï¼Ÿ</p><p>æœ‰ï¼æˆ‘ä»¬å¯ä»¥åœ¨ä¸¤ä¸ªè¯­è¨€ä¸­ä½¿ç”¨ protobuf æ¥åºåˆ—åŒ–/ååºåˆ—åŒ–è¦ä¼ é€’çš„æ•°æ®ã€‚åœ¨ Mozilla çš„ä¸€ç¯‡åšæ–‡ Crossing the Rust FFI frontier with Protocol Buffersï¼Œæåˆ°äº†è¿™ç§æ–¹æ³•ï¼š-</p><p>æ„Ÿå…´è¶£çš„åŒå­¦ï¼Œå¯ä»¥è¯»è¯»è¿™ç¯‡æ–‡ç« ã€‚ä¹Ÿå¯ä»¥çœ‹çœ‹æˆ‘ä¹‹å‰å†™çš„æ–‡ç« æ·±åº¦æ¢ç´¢ï¼šå‰ç«¯ä¸­çš„åç«¯ï¼Œè¯¦ç»†æ¢è®¨äº†æŠŠ Rust ç”¨åœ¨å®¢æˆ·ç«¯é¡¹ç›®ä¸­çš„å¯èƒ½æ€§ä»¥åŠå¦‚ä½•åš Rust bridgeã€‚</p><p>å°ç»“</p><p>FFI æ˜¯ Rust åˆä¸€ä¸ªå¤„äºé¢†å…ˆåœ°ä½çš„é¢†åŸŸã€‚</p><p>ä»è¿™ä¸€è®²çš„ç¤ºä¾‹ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æ”¯æŒå¾ˆæ–¹ä¾¿åœ°ä½¿ç”¨ C/C++ ç¤¾åŒºé‡Œçš„æˆæœå¤–ï¼ŒRust ä¹Ÿå¯ä»¥éå¸¸æ–¹ä¾¿åœ°åœ¨å¾ˆå¤šåœ°æ–¹å–ä»£ C/C++ï¼Œæˆä¸ºå…¶å®ƒè¯­è¨€ä½¿ç”¨åº•å±‚åº“çš„é¦–é€‰ã€‚é™¤äº†æ–¹ä¾¿çš„ FFI æ¥å£å’Œå·¥å…·é“¾ï¼Œä½¿ç”¨ Rust ä¸ºå…¶å®ƒè¯­è¨€æä¾›åº•å±‚æ”¯æŒï¼Œå…¶å®è¿˜æœ‰å®‰å…¨æ€§è¿™ä¸ªæ€æ‰‹é”ã€‚</p><p>æ¯”å¦‚åœ¨ Erlang/Elixir ç¤¾åŒºï¼Œé«˜æ€§èƒ½çš„åº•å±‚ NIF ä»£ç ï¼Œå¦‚æœç”¨ C/C++ æ’°å†™çš„è¯ï¼Œä¸€ä¸ªä¸å°å¿ƒå°±å¯èƒ½å¯¼è‡´æ•´ä¸ª VM çš„å´©æºƒï¼›ä½†æ˜¯ç”¨ Rust æ’°å†™ï¼Œå› ä¸ºå…¶ä¸¥æ ¼çš„å†…å­˜å®‰å…¨ä¿è¯ï¼ˆåªè¦ä¿è¯ unsafe ä»£ç çš„æ­£ç¡®æ€§ï¼‰ï¼ŒNIF ä¸ä¼šå¯¼è‡´ VM çš„å´©æºƒã€‚</p><p>æ‰€ä»¥ï¼Œç°åœ¨ Rust è¶Šæ¥è¶Šå—åˆ°å„ä¸ªé«˜çº§è¯­è¨€çš„é’çï¼Œç”¨æ¥å¼€å‘é«˜æ€§èƒ½çš„åº•å±‚åº“ã€‚</p><p>ä¸æ­¤åŒæ—¶ï¼Œå½“éœ€è¦å¼€å‘è·¨è¶Šå¤šä¸ªç«¯çš„å…¬å…±åº“æ—¶ï¼Œä½¿ç”¨ Rust ä¹Ÿä¼šæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ï¼Œæˆ‘ä»¬åœ¨å‰é¢çš„å†…å®¹ä¸­ä¹Ÿçœ‹åˆ°äº†ç”¨ uniffi ä¸º Android å’Œ iOS æ„å»ºå…¬å…±ä»£ç æ˜¯å¤šä¹ˆç®€å•çš„ä¸€ä»¶äº‹ã€‚</p><p>æ€è€ƒé¢˜</p><div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">é˜…è¯» </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">std</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::ffi çš„æ–‡æ¡£ï¼Œæƒ³æƒ³ Vec å¦‚ä½•ä¼ é€’ç»™ Cï¼Ÿå†æƒ³æƒ³ HashMap è¯¥å¦‚ä½•ä¼ é€’ï¼Ÿæœ‰å¿…è¦ä¼ é€’ä¸€ä¸ª HashMap åˆ° C é‚£ä¸€ä¾§ä¹ˆï¼Ÿ</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">é˜…è¯» rocksdb çš„ä»£ç ï¼Œçœ‹çœ‹ Rust å¦‚ä½•æä¾› rocksDB çš„ç»‘å®šã€‚</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">å¦‚æœä½ æ˜¯ä¸ª iOS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Android å¼€å‘è€…ï¼Œå°è¯•ä½¿ç”¨ Rust çš„ reqwest æ„å»º REST API å®¢æˆ·ç«¯ï¼Œç„¶åæŠŠå¾—åˆ°çš„æ•°æ®é€šè¿‡ FFI ä¼ é€’ç»™ Swift</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Kotlin ä¾§ã€‚</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>æ„Ÿè°¢ä½ çš„æ”¶å¬ï¼Œä»Šå¤©å®Œæˆäº†ç¬¬31æ¬¡Rustå­¦ä¹ æ‰“å¡å•¦ã€‚å¦‚æœä½ è§‰å¾—æœ‰æ”¶è·ï¼Œä¹Ÿæ¬¢è¿ä½ åˆ†äº«ç»™èº«è¾¹çš„æœ‹å‹ï¼Œé‚€ä»–ä¸€èµ·è®¨è®ºã€‚æˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ï½</p>',158)]))}]]);export{p as __pageData,l as default};
